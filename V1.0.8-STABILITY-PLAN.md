# v1.0.8 Stability Improvements Plan

## Overview

Focus on making Signaler more stable, reliable, and user-friendly without adding new features. This release addresses common failure modes, improves error handling, and enhances the installation experience.

## Priority Areas

### 1. Installation & Setup Stability ⭐⭐⭐

**Current Issues:**
- Installer can fail silently during npm install
- No verification that installation completed successfully
- Missing Node.js version check
- No clear guidance when installation fails

**Improvements:**
- ✅ Add Node.js version validation (require 16+)
- ✅ Add installation verification step
- ✅ Better error messages with recovery steps
- ✅ Verify dist/bin.js exists after build
- ✅ Test the CLI works before declaring success

**Files to modify:**
- `scripts/quick-install.ps1`
- `install.ps1`
- `install.sh`

### 2. CLI Error Handling ⭐⭐⭐

**Current Issues:**
- Generic error messages that don't help users
- Crashes without cleanup
- No graceful degradation
- Missing config file errors are cryptic

**Improvements:**
- ✅ Better error messages for common failures
- ✅ Graceful handling of missing config files
- ✅ Cleanup on interrupt (Ctrl+C)
- ✅ Validate config before running audits
- ✅ Check if baseUrl is accessible before starting
- ✅ Better Chrome connection error messages

**Files to modify:**
- `src/bin.ts`
- `src/cli.ts`
- `src/lighthouse-runner.ts`
- `src/core/config.ts`

### 3. Lighthouse Runner Stability ⭐⭐⭐

**Current Issues:**
- Chrome disconnects during long runs
- Timeout errors without retry
- Memory leaks in parallel mode
- No recovery from transient failures

**Improvements:**
- ✅ Add retry logic for transient Chrome errors
- ✅ Better timeout handling
- ✅ Cleanup Chrome processes on failure
- ✅ Memory monitoring and warnings
- ✅ Automatic fallback to stable mode on repeated failures

**Files to modify:**
- `src/lighthouse-runner.ts`
- `src/lighthouse-worker.ts`
- `src/runners/lighthouse/`

### 4. Configuration Validation ⭐⭐

**Current Issues:**
- Invalid configs cause runtime errors
- No validation before starting audits
- Unclear error messages for config problems

**Improvements:**
- ✅ Validate apex.config.json schema upfront
- ✅ Check baseUrl format and accessibility
- ✅ Validate page paths
- ✅ Warn about common misconfigurations
- ✅ Suggest fixes for invalid configs

**Files to modify:**
- `src/core/config.ts`
- `src/wizard-cli.ts`

### 5. Parallel Execution Stability ⭐⭐

**Current Issues:**
- Race conditions in parallel mode
- Chrome instances not cleaned up
- Memory exhaustion with high parallelism

**Improvements:**
- ✅ Better worker pool management
- ✅ Cleanup workers on failure
- ✅ Memory-aware parallelism limits
- ✅ Automatic reduction of parallelism on failures

**Files to modify:**
- `src/lighthouse-runner.ts`
- `src/measure-runner.ts`

### 6. User Experience Improvements ⭐

**Current Issues:**
- No progress indication for long operations
- Unclear what's happening during audits
- No way to cancel long-running operations gracefully

**Improvements:**
- ✅ Better progress indicators
- ✅ ETA for long operations
- ✅ Graceful cancellation (Ctrl+C)
- ✅ Clear status messages

**Files to modify:**
- `src/cli.ts`
- `src/shell-cli.ts`
- `src/ui/`

## Implementation Checklist

### Phase 1: Installation Stability (High Priority)
- [ ] Add Node.js version check to installers
- [ ] Add installation verification
- [ ] Improve error messages in installers
- [ ] Test installation on clean systems
- [ ] Update installation documentation

### Phase 2: Error Handling (High Priority)
- [ ] Add config validation before audits
- [ ] Improve error messages throughout CLI
- [ ] Add graceful shutdown on Ctrl+C
- [ ] Add baseUrl accessibility check
- [ ] Better Chrome connection error handling

### Phase 3: Lighthouse Stability (High Priority)
- [ ] Add retry logic for transient errors
- [ ] Improve timeout handling
- [ ] Add Chrome process cleanup
- [ ] Add memory monitoring
- [ ] Implement automatic fallback to stable mode

### Phase 4: Configuration (Medium Priority)
- [ ] Add JSON schema validation
- [ ] Add baseUrl format validation
- [ ] Add path validation
- [ ] Add configuration suggestions
- [ ] Improve wizard validation

### Phase 5: Parallel Execution (Medium Priority)
- [ ] Improve worker pool management
- [ ] Add worker cleanup on failure
- [ ] Add memory-aware limits
- [ ] Add automatic parallelism reduction

### Phase 6: UX Polish (Low Priority)
- [ ] Better progress indicators
- [ ] Add ETA calculations
- [ ] Improve status messages
- [ ] Add cancellation handling

## Testing Strategy

### Manual Testing
1. **Installation Testing**
   - Test on clean Windows system
   - Test on clean macOS system
   - Test on clean Linux system
   - Test with missing Node.js
   - Test with old Node.js version

2. **Error Scenario Testing**
   - Test with missing config
   - Test with invalid config
   - Test with unreachable baseUrl
   - Test with Chrome crashes
   - Test with network failures

3. **Stability Testing**
   - Run large audits (50+ pages)
   - Test parallel mode with high concurrency
   - Test with limited memory
   - Test cancellation (Ctrl+C)
   - Test recovery from failures

### Automated Testing
- [ ] Add unit tests for config validation
- [ ] Add integration tests for error handling
- [ ] Add tests for retry logic
- [ ] Add tests for cleanup on failure

## Success Metrics

### Installation
- ✅ Installation succeeds on clean systems
- ✅ Clear error messages when installation fails
- ✅ Verification that CLI works after installation

### Reliability
- ✅ <1% crash rate for normal audits
- ✅ Graceful degradation on failures
- ✅ Automatic recovery from transient errors
- ✅ No orphaned Chrome processes

### User Experience
- ✅ Clear error messages for all failure modes
- ✅ Progress indication for long operations
- ✅ Graceful cancellation
- ✅ Helpful suggestions for common problems

## Breaking Changes

**None** - This is a stability release with no breaking changes.

## Documentation Updates

- [ ] Update README with troubleshooting section
- [ ] Update INSTALL.md with common issues
- [ ] Add TROUBLESHOOTING.md (simple version)
- [ ] Update CHANGELOG.md

## Release Timeline

1. **Week 1**: Phase 1 & 2 (Installation + Error Handling)
2. **Week 2**: Phase 3 (Lighthouse Stability)
3. **Week 3**: Phase 4 & 5 (Config + Parallel)
4. **Week 4**: Phase 6 + Testing + Documentation
5. **Release**: v1.0.8

## Quick Wins (Can implement immediately)

### 1. Node.js Version Check
```typescript
// Add to bin.ts
const nodeVersion = process.versions.node;
const major = parseInt(nodeVersion.split('.')[0], 10);
if (major < 16) {
  console.error(`Node.js 16+ required. You have ${nodeVersion}`);
  process.exit(1);
}
```

### 2. Config Validation
```typescript
// Add to config.ts
function validateConfig(config: ApexConfig): string[] {
  const errors: string[] = [];
  
  if (!config.baseUrl) {
    errors.push('baseUrl is required');
  } else if (!config.baseUrl.startsWith('http')) {
    errors.push('baseUrl must start with http:// or https://');
  }
  
  if (!config.pages || config.pages.length === 0) {
    errors.push('At least one page is required');
  }
  
  return errors;
}
```

### 3. Better Error Messages
```typescript
// Improve error handling in bin.ts
catch (error: unknown) {
  if (error instanceof Error) {
    if (error.message.includes('ENOENT')) {
      console.error('Config file not found.');
      console.error('Run: signaler wizard');
      return;
    }
    if (error.message.includes('ECONNREFUSED')) {
      console.error('Cannot connect to baseUrl.');
      console.error('Make sure your dev server is running.');
      return;
    }
  }
  throw error;
}
```

### 4. Installation Verification
```powershell
# Add to install scripts
Write-Host "Verifying installation..." -ForegroundColor Yellow
$TestResult = & "$InstallDir\signaler.cmd" --version 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "✓ Installation verified!" -ForegroundColor Green
} else {
    Write-Host "✗ Installation verification failed" -ForegroundColor Red
    Write-Host "Error: $TestResult" -ForegroundColor Red
}
```

## Next Steps

1. Review and approve this plan
2. Prioritize which improvements to implement first
3. Create GitHub issues for each improvement
4. Start with quick wins
5. Implement in phases
6. Test thoroughly
7. Update documentation
8. Release v1.0.8

## Notes

- Focus on stability, not new features
- Every change should make the CLI more reliable
- Prioritize user-facing improvements
- Keep changes backward compatible
- Document all improvements in CHANGELOG